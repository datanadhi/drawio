name: Export Drawio diagrams to SVG

on:
  push:
    paths:
      - "**/*.drawio"
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Export drawio files to SVG
        uses: rlespinasse/drawio-export-action@v2
        with:
          format: svg
          transparent: true
          remove-page-suffix: true

      - name: Add theme-aware CSS to SVG files
        run: |
          find . -name "*.svg" -type f | while read svg; do
            # Add style element after opening svg tag for dark mode support
            if grep -q '<svg' "$svg" && ! grep -q 'prefers-color-scheme' "$svg"; then
              # Insert style tag right after the opening <svg> tag
              perl -i -pe 's/(<svg[^>]*>)/\1\n  <style>\n    @media (prefers-color-scheme: dark) {\n      svg { filter: invert(0.9) hue-rotate(180deg); }\n    }\n  <\/style>/s' "$svg"
            fi
          done

      - name: Commit exported SVGs
        run: |
          git config user.name "drawio-bot"
          git config user.email "drawio-bot@users.noreply.github.com"

          git add "**/*.svg"
          git commit -m "auto: export drawio diagrams to svg" || exit 0
          git push
